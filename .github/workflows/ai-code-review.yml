name: AI Code Review (GLM Powered)

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    # Permissions required to read the repository and comment on PRs
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      - name: Run GLM-Powered Review
        env:
          # Anthropic-compatible endpoint (GLM / proxy)
          ANTHROPIC_BASE_URL: ${{ secrets.GLM_ANTHROPIC_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.GLM_ANTHROPIC_AUTH_TOKEN }}

          # Model mapping (important)
          ANTHROPIC_DEFAULT_HAIKU_MODEL: glm-4.5-air
          ANTHROPIC_DEFAULT_SONNET_MODEL: glm-4.7
          ANTHROPIC_DEFAULT_OPUS_MODEL: glm-4.7

          # Disable interactivity for CI environment
          CI: true
        run: |
          echo "ðŸ” Generating PR diff..."
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff

          echo "ðŸ“„ Diff preview:"
          head -n 200 pr.diff

          echo "ðŸ¤– Running GLM-powered code review..."
          claude "
          Please review the code changes provided in pr.diff and output a Markdown report.

          1. Identify potential bugs (including edge cases, null handling, and concurrency issues).
          2. Suggest performance or maintainability improvements.
          3. Point out any security or coding style issues.
          4. If the overall code quality is good, clearly state **LGTM** at the end.

          Requirements:
          - Use clear section headings
          - Do not repeat the diff content
          - Do not include unrelated explanations
          " < pr.diff > review_report.md

      - name: Post Comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const body = fs.readFileSync('review_report.md', 'utf8');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ðŸ¤– AI Code Review (GLM Powered)\n\n${body}`
            });
